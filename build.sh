#!/bin/bash
set -euo pipefail

readonly BUILD_DIR="build"
readonly EXECUTABLE="safe_arithmetic_ops_exec"

# ANSI 컬러 정의
readonly RED="\033[1;31m"
readonly GREEN="\033[1;32m"
readonly YELLOW="\033[1;33m"
readonly CYAN="\033[1;36m"
readonly RESET="\033[0m"

# 실시간 로그 함수들
log_info()  { echo -e "${GREEN}[INFO][$(date '+%H:%M:%S')]${RESET} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN][$(date '+%H:%M:%S')]${RESET} $*"; }
log_debug() { echo -e "${CYAN}[DEBUG][$(date '+%H:%M:%S')]${RESET} $*"; }
log_fail()  { echo -e "${RED}[FAIL][$(date '+%H:%M:%S')]${RESET} $*" >&2; exit 1; }

banner() {
cat << "EOF"
                        ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡟⠁⠀⠀⠀⠀⠀⢀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠻⣏⠁⠀⠀⠀⠀⠀⠀⠀
                        ⠀⠀⠀⠀⠀⠀⢀⣀⣤⣤⣶⠖⡺⠋⠀⠀⠀⠀⠀⠀⣰⠛⠁⠀⢀⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⢦⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣿⣿⣶⢤⣄⣀⡀⠀
                        ⠀⢀⣀⣤⣶⣿⣿⣿⣿⣿⣟⡼⠁⢤⠀⠀⠀⠀⢀⣼⠃⠀⠀⢀⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢣⡀⠀⠀⠀⠀⢀⡴⢄⢹⣿⣿⣧⣴⣿⣿⣿⣿
                        ⣶⣿⣿⣿⣿⣿⣿⣿⣿⢋⡟⠁⠀⢸⠧⡀⠀⢰⡞⠀⠀⡴⢻⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣳⡀⠀⠀⠀⢸⠀⠈⠻⣿⣿⣿⡈⢻⣿⣿⣿
                        ⣿⣿⣿⣿⣿⣿⣿⣿⣇⡞⠀⠀⠀⠉⢠⠃⠠⡼⠁⠀⣸⠁⣼⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞⢦⢳⡀⠀⠀⢸⡀⠀⠀⢻⣿⣿⣷⢿⣿⣿⣿
                        ⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⢀⠄⣠⠏⠀⣸⠁⢠⢶⠃⡴⢹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⢣⠀⡇⢳⡀⠀⠨⣇⠀⠀⠘⣿⣿⣿⡄⢹⣿⣿
                        ⢿⣿⣿⣿⣿⣿⣿⠏⠀⠀⣰⠋⠉⠁⢠⢲⠇⠀⡞⠀⠉⠀⣸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠓⠃⠐⢧⠀⠀⠸⡄⠀⠀⢹⣿⣿⣷⡿⣿⣿
                        ⠀⢹⣿⣿⣿⣿⡟⠀⠈⠉⠁⠀⠀⠀⢀⡏⡄⢸⠁⠀⠀⠀⢹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⡆⠀⠀⠉⠒⠚⠀⢿⣿⣿⣧⠈⣿
                        ⠀⠈⢿⣿⣿⡿⠁⠀⣠⠀⠀⠀⠀⢀⣸⠁⠀⣾⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢻⠀⠀⠀⠀⠀⠀⠈⣿⣿⣿⣷⠻
                        ⠀⠀⠈⠻⣿⠃⠀⠀⡏⠀⠀⠀⠀⢠⡇⠀⠀⣿⠀⠀⠀⠀⣸⡇⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣇⠀⠀⠀⢀⢸⣦⠀⠀⠀⠀⠀⠀⠀⢈⡇⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣧
                        ⠀⠀⠀⢀⡏⠀⠀⢸⠃⠀⠀⠀⠀⣼⡇⠀⢀⣿⡀⠀⠀⠀⣧⣽⡀⠈⡇⠀⠀⠀⠠⡄⠀⠀⠀⠀⠀⢠⣿⡂⠀⠀⠀⠯⣿⣆⠀⠀⢦⠀⠀⠀⢸⢿⠀⠀⠀⠀⠀⠐⡆⠈⢿⣿⣿
                        ⠀⠀⠀⣼⠀⠀⠀⢸⠀⠀⠀⠀⢂⣿⠀⢀⣾⠋⣇⡀⠀⠁⣧⠃⠹⣴⠻⡄⠀⠀⠪⢻⡀⠀⠀⠀⠀⢸⣷⠳⡄⠀⠀⠀⢧⠺⣧⡀⠘⡆⠀⠀⢸⢸⠀⠀⠀⠀⠀⠀⡇⠀⠀⢏⠋
                        ⠀⠀⣰⡇⠀⠀⠀⢸⠀⠀⠀⠀⢸⣿⢰⠟⠀⠀⠈⠣⣀⠀⢻⠀⠀⠈⠳⢽⣷⣄⠀⠈⢻⣆⡀⠀⠀⠀⢘⡇⠘⢦⡀⠀⢘⡄⠀⠙⢦⡇⠀⠀⡼⢸⡄⠀⠀⠀⠀⠀⡇⠀⠀⠸⡄
                        ⠀⢸⣿⠁⠀⠀⠀⢸⠀⠀⠀⠀⣸⡿⠋⠀⠀⠀⠀⠀⠈⠓⠾⠀⠀⠀⠀⠀⠈⠻⢷⣤⡄⠳⡙⠷⣀⠀⠀⠿⡄⠀⠉⠳⢄⣱⡀⠀⠀⣷⣄⡾⢳⡀⡇⠀⠀⠀⠀⠀⡇⠀⠀⠀⠃
                        ⢀⡞⡏⠀⠀⠀⠀⢸⢀⠀⠀⠀⡟⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⠒⠻⠀⠀⠉⠒⠒⠗⠀⠀⠀⠀⠉⠁⠀⢠⡧⠋⠀⠀⠙⡇⠀⠀⠀⠀⢰⡇⠀⠀⠀⠀
                        ⣾⢱⠃⠀⠀⠀⠀⠘⡇⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀
                        ⡏⣸⠀⠀⠀⠀⠀⠀⢷⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠒⠦⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡤⠖⠊⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⢠⠇⠀⠀⠀⠀⠀
                        ⠁⡇⡀⠀⠀⠀⠀⠀⢸⡀⠀⠀⡇⠀⢀⣠⣴⠶⡾⣻⣿⣷⣒⡒⣦⣤⣄⡉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣁⣤⣴⣶⠾⣿⡻⣿⡟⠲⢲⣦⣀⡀⠀⡇⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀
                        ⢰⠇⣇⠀⠀⠀⠀⠀⠀⢧⠀⠀⣧⠶⠿⠟⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠒⠀⠀⠀⠀⠀⠀⠀⠀⠀⠚⠛⠛⠛⠛⠛⠛⠛⠻⠛⠛⠒⠛⠛⠛⠷⣏⠀⠀⢰⠇⠀⠀⠀⠀⠀⠘
                        ⠸⠀⢹⠀⠀⠀⠀⠀⠀⠾⡄⠄⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⡯⠀⣴⡟⠀⠀⠀⠀⠀⠀⠀
                        ⠀⠀⠈⣇⠀⠀⠀⠀⠀⠀⢻⡀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠀⣸⠀⠠⡍⠀⠀⠀⠀⠀⢠⠆⠀
                        ⠀⠀⠀⠸⡄⠀⠀⠀⠀⠀⠉⢷⠘⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡇⠀⣾⠁⠀⠀⠀⠀⣴⠋⠀⠀
                        ⠀⠀⠀⠀⡻⣄⠀⠀⠀⠀⠀⢐⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡸⠠⣾⠻⠀⠀⠀⢀⡴⠁⠀⠀⠀
                        ⠀⠀⠀⠀⠈⠙⣄⠀⠀⠀⠀⠀⠙⣷⡀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠓⡼⠃⠀⠀⢀⡰⠋⠀⠀⠀⠀⠀
                        ⢀⠀⠀⠀⠀⠀⠈⢧⡀⠀⠀⠀⠀⠨⣳⡀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢯⡓⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⢒⡾⠋⠀⠀⠀⠀⠀⠀⠀⠀⢠⢏⡜⠁⠀⠀⣠⠞⠁⠀⠀⠀⠀⠀⠀
                        ⢸⢀⠀⠀⠀⠀⠀⠀⠙⢦⡀⠀⠀⠀⠙⠻⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⠒⠒⠢⠤⠤⠤⠤⠔⠒⠒⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⠾⠀⠀⣠⠞⠁⠀⠀⠀⠀⠀⠀⠀⠀
                        ⢸⣎⢧⠀⠀⠀⠀⠀⠀⠀⠌⠳⢤⣀⠀⠀⠘⢆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡾⠃⢀⣤⠞⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
                        ⢸⣿⠍⠳⡀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠒⢶⠈⣳⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠞⢀⡴⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
                        ⠀⠘⣾⡀⠙⢆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣍⠙⠒⡶⢤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣠⣤⡶⢲⡏⢱⢏⡴⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
                        ⠀⠀⢻⣆⠣⠀⠱⢄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⢧⡂⠄⡼⡟⣭⣿⠛⠻⠿⣿⣿⣿⣿⣿⣿⣿⠿⠟⠋⠉⠁⣗⢲⣧⣯⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡴⠁⠀⡼
                        ⣰⠀⠀⣿⣦⠀⠀⠀⠑⢦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢳⣼⣿⣿⠓⢾⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡠⠞⠉⢀⡏⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠞⠋⠀⣠⣿⠃
                        ⣿⣧⡀⢸⣾⢷⣄⠀⠀⠀⠈⠓⠤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⣿⡷⢦⡀⠉⠲⣄⠀⠀⠀⠀⠀⠀⢀⡤⠒⠉⠀⠀⠀⢸⡀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡠⠖⠋⠀⠀⠀⣵⡏⠀⠀
                        ⠛⢻⣿⣦⣧⣿⣿⣷⣶⣤⠀⠀⠀⠀⠉⠒⠢⢤⣀⠀⠀⠀⠀⠀⠸⡄⠀⠉⣶⣦⣬⡓⢤⣀⣤⡤⡚⠉⠀⠀⠀⠀⠄⣶⡟⠁⠀⠀⠀⠀⢀⣠⡤⠚⠉⠀⠀⠀⢀⣠⡞⠁⠁⠀⠀

   .---.  .--.  ,---.,---.    .--.  ,---.  ,-. _______ .-. .-.         ,---. _______ ,-.  ,--,  .---.  ,---.    .---. 
  ( .-._)/ /\ \ | .-'| .-'   / /\ \ | .-.\ |(||__   __|| | | ||\    /| | .-'|__   __||(|.' .') / .-. ) | .-.\  ( .-._)
 (_) \  / /__\ \| `-.| `-.  / /__\ \| `-'/ (_)  )| |   | `-' ||(\  / | | `-.  )| |   (_)|  |(_)| | |(_)| |-' )(_) \   
 _  \ \ |  __  || .-'| .-'  |  __  ||   (  | | (_) |   | .-. |(_)\/  | | .-' (_) |   | |\  \   | | | | | |--' _  \ \  
( `-'  )| |  |)|| |  |  `--.| |  |)|| |\ \ | |   | |   | | |)|| \  / | |  `--. | |   | | \  `-.\ `-' / | |   ( `-'  ) 
 `----' |_|  (_))\|  /( __.'|_|  (_)|_| \)\`-'   `-'   /(  (_)| |\/| | /( __.' `-'   `-'  \____\)---'  /(     `----'  
               (__) (__)                (__)          (__)    '-'  '-'(__)                     (_)    (__)            
EOF
}

main() {
    banner
    log_info "Initiating build protocol..."
    local start_time=$(date +%s)

    # 기존 디렉토리 제거
    if [[ -d "$BUILD_DIR" ]]; then
        log_warn "Purging old artifacts: $BUILD_DIR"
        rm -rf "$BUILD_DIR"
    fi

    # 빌드 디렉토리 생성 및 이동
    log_info "Creating build sandbox: $BUILD_DIR"
    mkdir -p "$BUILD_DIR"
    cd "$BUILD_DIR"

    # CMake 설정
    log_info "Bootstrapping CMake..."
    cmake .. || log_fail "CMake configuration failed"

    # 빌드
    log_info "Compiling source..."
    make -j"$(nproc)" || log_fail "Compilation failed"

    # 실행 확인 및 수행
    if [[ -x "$EXECUTABLE" ]]; then
        log_info "Launching binary → $EXECUTABLE help"
        echo ""
        "./$EXECUTABLE" help || log_fail "Runtime execution failed"
    else
        log_fail "Executable not found or not runnable"
    fi

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    log_info "Build completed successfully in ${duration}s. System is go."
}

main "$@"